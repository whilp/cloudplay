#!/usr/bin/env python

import json
import logging
import sys

from itertools import count
from urllib import urlencode
from urllib2 import Request, build_opener
from urlparse import urljoin

OFFICIALFM_ID = 'IvU9WMP8r3l3n5CJYgf3'

log = logging.getLogger(__name__)

def main():
    log.level = logging.DEBUG
    log.addHandler(logging.StreamHandler())

    client = SoundCloud()

    print client.list('/users/lt_kije/followings').next()

class SoundCloud(object):
    url = 'https://api.soundcloud.com/'
    client_id = 'bed25dba5cb38c07ca8d5bb9d92eb0a8'
    limit = 200
    format = "json"

    def __init__(self, **kwargs):
        self.opener = build_opener()

    def list(self, collection, **query):
        url = urljoin(self.url, collection)
        params = dict(
            client_id=self.client_id,
            format=self.json,
            limit=self.limit,
            )
        params.update(query)
        
        url = urljoin(self.url, collection)

        for offset in count():
            params["offset"] = offset
            requrl = url + '?' + urlencode(params)
            log.debug("GET %s", requrl)
            req = Request(requrl)
            response = self.opener.open(req)
            response = json.load(response)
            if not response:
                return
            for item in response:
                yield item

main()
